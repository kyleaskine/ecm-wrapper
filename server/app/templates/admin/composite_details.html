{% extends "base.html" %}

{% block title %}Composite Details - {{ composite.id }}{% endblock %}

{% block extra_head %}
<script>
    function backToDashboard() {
        const apiKey = sessionStorage.getItem('admin_api_key');
        if (!apiKey) {
            window.location.href = '/api/v1/admin/login';
            return;
        }

        fetch('/api/v1/admin/dashboard', {
            headers: {
                'X-Admin-Key': apiKey
            }
        })
        .then(response => response.text())
        .then(html => {
            document.open();
            document.write(html);
            document.close();
            history.pushState(null, '', '/api/v1/admin/dashboard');
        })
        .catch(() => {
            sessionStorage.removeItem('admin_api_key');
            window.location.href = '/api/v1/admin/login';
        });
    }

    function deleteComposite() {
        const apiKey = sessionStorage.getItem('admin_api_key');
        if (!apiKey) {
            window.location.href = '/api/v1/admin/login';
            return;
        }

        const compositeId = {{ composite.id }};
        const compositeNumber = "{{ composite.number[:50] }}...";

        if (!confirm(`Are you sure you want to delete composite ${compositeId}?\n\nNumber: ${compositeNumber}\n\nThis will permanently delete:\n- The composite record\n- All ECM attempts\n- All factors found\n- All work assignments\n\nThis action cannot be undone.`)) {
            return;
        }

        // Show loading state
        const deleteBtn = document.getElementById('delete-btn');
        const originalText = deleteBtn.textContent;
        deleteBtn.textContent = 'Deleting...';
        deleteBtn.disabled = true;

        fetch(`/api/v1/admin/composites/${compositeId}?reason=admin_manual_delete`, {
            method: 'DELETE',
            headers: {
                'X-Admin-Key': apiKey
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Delete failed: ${response.status}`);
            }
            return response.json();
        })
        .then(result => {
            alert(`Successfully deleted composite ${compositeId}\n\nDeleted:\n- ${result.deleted_attempts} attempts\n- ${result.deleted_factors} factors\n- ${result.deleted_work_assignments} work assignments`);
            backToDashboard();
        })
        .catch(error => {
            alert(`Failed to delete composite: ${error.message}`);
            deleteBtn.textContent = originalText;
            deleteBtn.disabled = false;
        });
    }
</script>
<style>
    .btn-danger {
        background-color: #dc3545;
        color: white;
        border: 1px solid #dc3545;
    }
    .btn-danger:hover {
        background-color: #c82333;
        border-color: #bd2130;
    }
    .header-actions {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }
</style>
{% endblock %}

{% block body %}
<div class="container">
    <div class="header">
        <h1>Composite Details</h1>
        <div class="header-actions">
            <button onclick="backToDashboard()" class="btn btn-secondary">‚Üê Back to Dashboard</button>
            <button id="delete-btn" onclick="deleteComposite()" class="btn btn-danger">üóëÔ∏è Delete Composite</button>
        </div>
    </div>

    <div class="card">
        <h2>Composite Information</h2>
        <table>
            <tr><th>ID</th><td>{{ composite.id }}</td></tr>
            <tr><th>Number</th><td class="number-display">{{ esc(composite.number) }}</td></tr>
            <tr><th>Digit Length</th><td>{{ composite.digit_length }}</td></tr>
            <tr><th>Priority</th><td>{{ composite.priority }}</td></tr>
            <tr><th>Created</th><td>{{ esc(composite.created_at) }}</td></tr>
            <tr><th>Last Updated</th><td>{{ esc(composite.updated_at) }}</td></tr>
            <tr><th>Status</th><td>
                {% if composite.is_fully_factored %}
                <span class="status-badge status-complete">Fully Factored</span>
                {% else %}
                <span class="status-badge status-active">Active</span>
                {% endif %}
                {% if composite.is_prime %}
                <span class="status-badge status-complete">Prime</span>
                {% endif %}
            </td></tr>
        </table>
    </div>

    {% set t_data = calc_t_progress(composite.current_t_level, composite.target_t_level) %}
    <div class="card">
        <h2>T-Level Progress</h2>
        <table>
            <tr><th>Current T-Level</th><td>t{{ t_data.current_t|round(2) }}</td></tr>
            <tr><th>Target T-Level</th><td>t{{ t_data.target_t|round(2) }}</td></tr>
            <tr><th>Progress</th><td>
                <div class="progress-bar-container">
                    <div class="progress-fill" style="width: {{ [t_data.progress_pct, 100]|min|round(1) }}%">
                        {{ t_data.progress_pct|round(1) }}%
                    </div>
                </div>
            </td></tr>
        </table>
    </div>

    <div class="card">
        <h2>Work Summary</h2>
        <table>
            <tr><th>Total Attempts</th><td>{{ progress.total_attempts }}</td></tr>
            <tr><th>Total ECM Curves</th><td>{{ "{:,}".format(progress.total_ecm_curves) }}</td></tr>
            <tr><th>P-1 Attempts</th><td>{{ progress.pm1_attempts }}</td></tr>
            <tr><th>Factors Found</th><td>{{ progress.factors_found|length }}</td></tr>
        </table>
    </div>

    {% if active_work %}
    <div class="card">
        <h2>Active Work Assignments</h2>
        <div class="table-wrapper">
            <table>
                <tr>
                    <th>Client ID</th>
                    <th>Method</th>
                    <th>B1</th>
                    <th>B2</th>
                    <th>Curves Requested</th>
                    <th>Status</th>
                    <th>Expires</th>
                </tr>
                {% for work in active_work %}
                <tr>
                    <td>{{ esc(work.client_id) }}</td>
                    <td>{{ esc(work.method) }}</td>
                    <td>{{ "{:,}".format(work.b1) }}</td>
                    <td>{% if work.b2 is none %}Default{% elif work.b2 == 0 %}Stage 1 only{% else %}{{ "{:,}".format(work.b2) }}{% endif %}</td>
                    <td>{{ work.curves_requested }}</td>
                    <td>{{ esc(work.status) }}</td>
                    <td>{{ esc(work.expires_at) }}</td>
                </tr>
                {% endfor %}
            </table>
        </div>
    </div>
    {% endif %}

    {% if factors_with_group_orders %}
    <div class="card">
        <h2>Factors with Elliptic Curve Group Order Data</h2>
        <div class="table-wrapper">
            <table>
                <tr>
                    <th>Factor</th>
                    <th>Sigma</th>
                    <th>Group Order</th>
                    <th>Group Order Factorization</th>
                </tr>
                {% for f in factors_with_group_orders %}
                <tr>
                    <td class="number-display">{{ esc(f.factor) }}</td>
                    <td>{{ "{:,}".format(f.sigma|int) if f.sigma else "N/A" }}</td>
                    <td class="number-display">{{ esc(f.group_order) if f.group_order else "N/A" }}</td>
                    <td class="number-display">{{ esc(f.group_order_factorization) if f.group_order_factorization else "N/A" }}</td>
                </tr>
                {% endfor %}
            </table>
        </div>
    </div>
    {% endif %}

    <div class="card">
        <h2>Recent ECM Attempts</h2>
        {% if recent_attempts %}
        <div class="table-wrapper">
            <table>
                <tr>
                    <th>Method</th>
                    <th>B1</th>
                    <th>B2</th>
                    <th>Curves Completed</th>
                    <th>Factor Found</th>
                    <th>Client</th>
                    <th>Submitted</th>
                </tr>
                {% for attempt in recent_attempts %}
                <tr>
                    <td>{{ esc(attempt.method) }}</td>
                    <td>{{ "{:,}".format(attempt.b1) }}</td>
                    <td>{% if attempt.b2 is none %}Default{% elif attempt.b2 == 0 %}Stage 1 only{% else %}{{ "{:,}".format(attempt.b2) }}{% endif %}</td>
                    <td>{{ "{:,}".format(attempt.curves_completed) }}</td>
                    <td>
                        {% if attempt.factor_found %}
                        {# Check if multiple factors were found by this attempt #}
                        {% set attempt_factors = db.query(Factor).filter(Factor.found_by_attempt_id == attempt.id).all() %}
                        {% if attempt_factors|length > 1 %}
                        <span style="cursor: help;" title="This attempt found {{ attempt_factors|length }} factors total">
                            {{ esc(attempt.factor_found[:30]) }}... <strong style="color: #2ecc71;">[+{{ attempt_factors|length - 1 }} more]</strong>
                        </span>
                        {% else %}
                        {{ esc(attempt.factor_found) }}
                        {% endif %}
                        {% else %}
                        None
                        {% endif %}
                    </td>
                    <td>{{ esc(attempt.client_id) }}</td>
                    <td>{{ esc(attempt.created_at) }}</td>
                </tr>
                {% endfor %}
            </table>
        </div>
        {% else %}
        <p>No attempts yet.</p>
        {% endif %}
    </div>
</div>
{% endblock %}
