{% extends "base.html" %}

{% block title %}ECM Admin Dashboard{% endblock %}

{% block extra_head %}
<script>
    // Check if API key exists, redirect to login if not
    const API_KEY = sessionStorage.getItem('admin_api_key');
    if (!API_KEY) {
        window.location.href = '/api/v1/admin/login';
    }

    // Add API key to all fetch requests
    function fetchWithAuth(url, options = {}) {
        options.headers = options.headers || {};
        options.headers['X-Admin-Key'] = sessionStorage.getItem('admin_api_key');
        return fetch(url, options).then(response => {
            if (response.status === 401) {
                sessionStorage.removeItem('admin_api_key');
                window.location.href = '/api/v1/admin/login';
                throw new Error('Unauthorized');
            }
            return response;
        });
    }

    // Logout function
    function logout() {
        sessionStorage.removeItem('admin_api_key');
        window.location.href = '/api/v1/admin/login';
    }

    // Jump to composite by ID
    function jumpToComposite() {
        const compositeId = document.getElementById('composite-jump-id').value.trim();
        if (!compositeId || isNaN(compositeId)) {
            alert('Please enter a valid composite ID (number)');
            return;
        }

        const apiKey = sessionStorage.getItem('admin_api_key');
        if (!apiKey) {
            window.location.href = '/api/v1/admin/login';
            return;
        }

        // Fetch the composite details page with auth header
        fetch(`/api/v1/admin/composites/${compositeId}/details`, {
            headers: {
                'X-Admin-Key': apiKey
            }
        })
        .then(response => {
            if (response.status === 404) {
                alert(`Composite ${compositeId} not found`);
                throw new Error('Not found');
            }
            if (!response.ok) {
                throw new Error(`Failed to load composite: ${response.status}`);
            }
            return response.text();
        })
        .then(html => {
            document.open();
            document.write(html);
            document.close();
            history.pushState(null, '', `/api/v1/admin/composites/${compositeId}/details`);
        })
        .catch(error => {
            if (error.message !== 'Not found') {
                console.error('Error loading composite:', error);
            }
        });
    }

    // Allow Enter key in the input field
    function handleJumpKeyPress(event) {
        if (event.key === 'Enter') {
            jumpToComposite();
        }
    }
</script>
{% endblock %}

{% block body %}
<div class="header">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
        <div>
            <h1>üîß ECM Coordination Dashboard</h1>
            <p>Distributed ECM coordination middleware - work assignment and t-level progress tracking</p>
        </div>
        <button onclick="logout()" class="btn" style="background: #dc3545;">Logout</button>
    </div>
</div>

<div class="section">
    <div class="section-header">üîç Quick Navigation</div>
    <div class="section-content">
        <div style="display: flex; gap: 10px; align-items: center; max-width: 500px;">
            <label for="composite-jump-id" style="font-weight: 600; white-space: nowrap;">Jump to Composite ID:</label>
            <input
                type="text"
                id="composite-jump-id"
                placeholder="Enter composite ID (e.g., 14743)"
                onkeypress="handleJumpKeyPress(event)"
                style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
            />
            <button onclick="jumpToComposite()" class="btn btn-primary" style="white-space: nowrap;">Go ‚Üí</button>
        </div>
    </div>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-number">{{ summary_stats.overview.total_composites }}</div>
        <div class="stat-label">Total Composites</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ summary_stats.overview.active_work_assignments }}</div>
        <div class="stat-label">Active Work</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ summary_stats.overview.active_clients }}</div>
        <div class="stat-label">Active Clients</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ summary_stats.health.work_queue_utilization }}%</div>
        <div class="stat-label">Queue Utilization</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ summary_stats.t_level_targeting.composites_with_targets }}</div>
        <div class="stat-label">T-Level Targets Set</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ summary_stats.health.t_level_coverage }}%</div>
        <div class="stat-label">T-Level Coverage</div>
    </div>
</div>

<div class="section">
    <div class="section-header">üìä ECM Progress Overview</div>
    <div class="section-content">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
            <div>
                <strong>Work Queue Status:</strong>
                {% set queue_util = summary_stats.health.work_queue_utilization %}
                <span class="{{ get_health_class(queue_util, 50, 0) }}">{{ queue_util }}% utilized</span>
            </div>
            <div>
                <strong>T-Level Coverage:</strong>
                {% set coverage = summary_stats.health.t_level_coverage %}
                <span class="{{ get_health_class(coverage) }}">{{ coverage }}%</span>
            </div>
            <div>
                <strong>Recent Activity (24h):</strong>
                {{ summary_stats.recent_activity_24h.new_attempts }} attempts, {{ summary_stats.recent_activity_24h.factors_found }} factors
            </div>
        </div>

        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
            <h4 style="margin-top: 0;">‚ö° ECM Coordination Status</h4>
            <p style="margin: 0; color: #666;">
                This system coordinates distributed ECM work across clients, tracking t-level progress and managing the work queue.
                Projects can submit numbers with target t-levels and receive factorization results.
            </p>
        </div>
    </div>
</div>

<div class="section">
    <div class="section-header">‚ö° Active Work Assignments</div>
    <div class="section-content">
        {% if recent_work %}
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Work ID</th>
                        <th>Client</th>
                        <th>Composite (digits)</th>
                        <th>T-Level Target</th>
                        <th>Method</th>
                        <th>Parameters</th>
                        <th>Progress</th>
                        <th>Status</th>
                        <th>Expires</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for work in recent_work %}
                    {% set progress_pct = (work.curves_completed / work.curves_requested * 100) if work.curves_requested > 0 else 0 %}
                    {% set status_class = format_work_status(work.status) %}
                    {% set composite_display = work.composite.number[:20] + '...' if work.composite.number|length > 20 else work.composite.number %}
                    {% set time_str = format_time(work.expires_at, now) %}
                    {% set current_t = work.composite.current_t_level or 0.0 %}
                    {% set target_t = work.composite.target_t_level or 0.0 %}
                    <tr>
                        <td><span class="number">{{ work.id[:8] }}...</span></td>
                        <td>{{ esc(work.client_id) }}</td>
                        <td><span class="number">{{ esc(composite_display) }}</span> ({{ work.composite.digit_length }})</td>
                        <td>
                            <span style="font-size: 0.9em;">üìä t{{ current_t|round(1) }}‚Üít{{ target_t|round(1) }}</span>
                        </td>
                        <td>{{ esc(work.method.upper()) }}</td>
                        <td>B1={{ "{:,}".format(work.b1) }}{% if work.b2 %}, B2={{ "{:,}".format(work.b2) }}{% endif %}</td>
                        <td>
                            <div class="progress">
                                <div class="progress-bar" style="width: {{ progress_pct }}%;"></div>
                            </div>
                            {{ work.curves_completed }}/{{ work.curves_requested }}
                        </td>
                        <td><span class="{{ status_class }}">{{ esc(work.status) }}</span></td>
                        <td>{{ esc(time_str) }}</td>
                        <td>
                            <button class="btn" onclick="expireWork('{{ work.id }}')" style="background: #ffc107; font-size: 0.85em; padding: 4px 8px; margin-right: 5px;">Expire</button>
                            <button class="btn" onclick="cancelWork('{{ work.id }}')" style="background: #dc3545; font-size: 0.85em; padding: 4px 8px;">Cancel</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p>No active work assignments</p>
        {% endif %}
    </div>
</div>

<div class="section">
    <div class="section-header">üìã Composite Queue - Sorted by ECM Completion</div>
    <div class="section-content">
        <p style="margin-bottom: 15px; color: #666; font-style: italic;">
            Showing unfactored composites sorted by completion percentage (closest to target t-level first)
        </p>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Number</th>
                        <th>Digits</th>
                        <th>T-Level Progress</th>
                        <th>Priority</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for composite in composites %}
                    {% set composite_display = composite.number[:30] + '...' if composite.number|length > 30 else composite.number %}
                    {% set created_str = composite.created_at.strftime('%Y-%m-%d %H:%M') if composite.created_at else 'Unknown' %}
                    {% set t_data = calc_t_progress(composite.current_t_level, composite.target_t_level) %}
                    <tr>
                        <td>{{ composite.id }}</td>
                        <td><span class="number">{{ esc(composite_display) }}</span></td>
                        <td>{{ composite.digit_length }}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div class="progress" style="width: 100px;">
                                    <div class="progress-bar" style="width: {{ [t_data.progress_pct, 100]|min }}%; background-color: {{ t_data.progress_color }};"></div>
                                </div>
                                <span style="font-size: 0.85em; font-weight: bold; color: {{ t_data.progress_color }};">
                                    t{{ t_data.current_t|round(1) }} / t{{ t_data.target_t|round(1) }} ({{ t_data.progress_pct|round(1) }}%)
                                </span>
                            </div>
                        </td>
                        <td>
                            <span style="font-weight: bold; color: {{ '#198754' if composite.priority > 0 else '#666' }};">{{ composite.priority }}</span>
                        </td>
                        <td>{{ esc(created_str) }}</td>
                        <td>
                            <button class="btn" onclick="viewDetails({{ composite.id }})" style="margin-right: 5px;">Details</button>
                            <button class="btn" onclick="removeComposite({{ composite.id }})" style="background: #dc3545;">Remove</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="section">
    <div class="section-header">üë• Recent Clients</div>
    <div class="section-content">
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Client ID</th>
                        <th>Work Count</th>
                        <th>Last Seen</th>
                    </tr>
                </thead>
                <tbody>
                    {% for client_info in recent_clients %}
                    {% set last_seen_str = client_info.last_seen.strftime('%Y-%m-%d %H:%M') if client_info.last_seen else 'Unknown' %}
                    <tr>
                        <td>{{ esc(client_info.client_id) }}</td>
                        <td>{{ client_info.work_count }}</td>
                        <td>{{ esc(last_seen_str) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="section">
    <div class="section-header">üéØ Recent Factors Found</div>
    <div class="section-content">
        {% if recent_factors %}
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Factor</th>
                        <th>Composite</th>
                        <th>Found</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for factor in recent_factors %}
                    {% set composite_display = factor.composite.number[:30] + '...' if factor.composite.number|length > 30 else factor.composite.number %}
                    {% set found_str = factor.created_at.strftime('%Y-%m-%d %H:%M') if factor.created_at else 'Unknown' %}
                    <tr>
                        <td><span class="number">{{ esc(factor.factor) }}</span></td>
                        <td><span class="number">{{ esc(composite_display) }}</span></td>
                        <td>{{ esc(found_str) }}</td>
                        <td>
                            <button onclick="deleteFactor({{ factor.id }}, '{{ esc(factor.factor) }}')"
                                    style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                üóëÔ∏è Delete
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p>No factors found recently</p>
        {% endif %}
    </div>
</div>

<div class="section">
    <div class="section-header">üìä Recent Curves (Aggregated by Composite)</div>
    <div class="section-content">
        <p style="margin-bottom: 15px; color: #666; font-style: italic;">
            Click any row to expand and see individual curve batches
        </p>
        {% if recent_attempts %}
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th></th> <!-- Expand icon -->
                        <th>Composite</th>
                        <th>Digits</th>
                        <th>T-Level Progress</th>
                        <th>Batches</th>
                        <th>Total Curves</th>
                        <th>Factors Found</th>
                        <th>First/Last Attempt</th>
                        <th>Total Time</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for agg in recent_attempts %}
                    {% set comp = agg.composite %}
                    {% set comp_display = (comp.number[:30] + '...') if comp.number|length > 30 else comp.number %}
                    {% set t_data = calc_t_progress(comp.current_t_level, comp.target_t_level) %}
                    {% set comp_digits = comp.current_composite|length if comp.current_composite else 0 %}
                    {% set comp_bits = (comp_digits * 3.322)|int if comp_digits > 0 else 0 %}
                    <!-- Main aggregated row -->
                    <tr class="composite-row" onclick="toggleExpand({{ comp.id }})" style="cursor: pointer; background: #f8f9fa;">
                        <td style="width: 30px; text-align: center;">
                            <span id="expand-icon-{{ comp.id }}" style="font-size: 1.2em;">‚ñ∂</span>
                        </td>
                        <td class="number">
                            <strong>{{ esc(comp_display) }}</strong>
                        </td>
                        <td>{{ comp_digits }}</td>
                        <td>
                            {% if t_data and t_data.target_t > 0 %}
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="progress" style="width: 80px;">
                                    <div class="progress-bar" style="width: {{ [t_data.progress_pct, 100]|min }}%; background-color: {{ t_data.progress_color }}"></div>
                                </div>
                                <span class="small-text" style="font-weight: bold; color: {{ t_data.progress_color }}">
                                    t{{ t_data.current_t|round(1) }}/t{{ t_data.target_t|round(1) }}
                                </span>
                            </div>
                            {% else %}
                            <span style="color: #999;">N/A</span>
                            {% endif %}
                        </td>
                        <td><strong>{{ agg.attempt_count }}</strong></td>
                        <td><strong>{{ "{:,}".format(agg.total_curves) }}</strong></td>
                        <td>
                            {% if agg.factors %}
                            <span class="factor" style="font-weight: bold;">{{ agg.factors|length }} factor{{ 's' if agg.factors|length > 1 else '' }}</span>
                            {% else %}
                            None
                            {% endif %}
                        </td>
                        <td class="small-text">
                            {{ agg.earliest_attempt.strftime('%Y-%m-%d %H:%M') }}<br/>
                            {{ agg.latest_attempt.strftime('%Y-%m-%d %H:%M') }}
                        </td>
                        <td>{{ (agg.total_time|round(1)) }}s</td>
                        <td onclick="event.stopPropagation();">
                            <button class="btn" onclick="viewDetails({{ comp.id }})" style="font-size: 0.85em; padding: 4px 8px;">Details</button>
                        </td>
                    </tr>
                    <!-- Expandable rows for individual attempts -->
                    {% for attempt in agg.attempts %}
                    <tr id="detail-{{ comp.id }}-{{ attempt.id }}" class="detail-row" style="display: none; background: #fff;">
                        <td></td>
                        <td colspan="2" class="small-text" style="padding-left: 30px;">
                            {{ attempt.method.upper() }} - B1={{ "{:,}".format(attempt.b1) }}{% if attempt.b2 %}, B2={{ "{:,}".format(attempt.b2) }}{% endif %}
                        </td>
                        <td></td>
                        <td class="small-text">1 batch</td>
                        <td class="small-text">{{ attempt.curves_completed }} curves</td>
                        <td>
                            {% if attempt.factor_found %}
                            {% set attempt_factors = db.query(Factor).filter(Factor.found_by_attempt_id == attempt.id).all() %}
                            {% if attempt_factors|length > 1 %}
                            <span class="factor small-text">{{ attempt.factor_found[:15] }}... <strong style="color: #2ecc71;">[+{{ attempt_factors|length - 1 }}]</strong></span>
                            {% else %}
                            <span class="factor small-text">{{ attempt.factor_found[:20] }}{{ '...' if attempt.factor_found|length > 20 else '' }}</span>
                            {% endif %}
                            {% else %}
                            <span class="small-text">None</span>
                            {% endif %}
                        </td>
                        <td class="small-text">{{ attempt.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td class="small-text">{{ (attempt.execution_time_seconds|round(1)) if attempt.execution_time_seconds else 'N/A' }}s</td>
                        <td onclick="event.stopPropagation();">
                            <button class="btn" onclick="deleteCurve({{ attempt.id }}, {{ comp.id }})" style="background: #dc3545; font-size: 0.75em; padding: 2px 6px;">Del</button>
                        </td>
                    </tr>
                    {% endfor %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p>No recent curves found</p>
        {% endif %}
    </div>
</div>

<div class="section">
    <div class="section-header">üõ†Ô∏è Admin Tools</div>
    <div class="section-content">
        <div class="tools">
            <h4>Quick Actions:</h4>
            <button class="btn" onclick="location.href='/docs#/admin'">API Documentation</button>
            <button class="btn" onclick="location.href='/api/v1/dashboard/'">User Dashboard</button>
            <button class="btn" onclick="cleanupExpired()">Cleanup Expired Work</button>
            <button class="btn" onclick="cleanupOrphanedResidues()">üßπ Cleanup Orphaned Residues</button>
            <button class="btn" onclick="calculateTLevels()">Calculate T-Levels</button>
            <button class="btn" onclick="recalculateAllTLevels()" style="background: #dc3545;">Fix Random T-Levels</button>
            <button class="btn" onclick="refreshPage()">Refresh</button>
        </div>

        <div style="margin-top: 20px;">
            <h4>Bulk Operations:</h4>
            <p>Use the API endpoints to:</p>
            <ul>
                <li><strong>POST /admin/composites/upload</strong> - Upload composite files</li>
                <li><strong>POST /admin/composites/bulk</strong> - Add numbers via JSON</li>
                <li><strong>GET /admin/work/assignments</strong> - View all work assignments</li>
                <li><strong>POST /admin/work/cleanup</strong> - Clean up expired work</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function toggleExpand(compositeId) {
        // Get the icon
        const icon = document.getElementById(`expand-icon-${compositeId}`);

        // Get all detail rows for this composite
        const detailRows = document.querySelectorAll(`tr[id^="detail-${compositeId}-"]`);

        // Toggle visibility
        const isExpanded = detailRows[0] && detailRows[0].style.display !== 'none';

        detailRows.forEach(row => {
            row.style.display = isExpanded ? 'none' : 'table-row';
        });

        // Toggle icon
        icon.textContent = isExpanded ? '‚ñ∂' : '‚ñº';
    }

    function viewDetails(compositeId) {
        const apiKey = sessionStorage.getItem('admin_api_key');
        if (!apiKey) {
            window.location.href = '/api/v1/admin/login';
            return;
        }

        // Fetch the details page with auth header
        fetch(`/api/v1/admin/composites/${compositeId}/details`, {
            headers: {
                'X-Admin-Key': apiKey
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Unauthorized');
            }
            return response.text();
        })
        .then(html => {
            document.open();
            document.write(html);
            document.close();
            history.pushState(null, '', `/api/v1/admin/composites/${compositeId}/details`);
        })
        .catch(() => {
            sessionStorage.removeItem('admin_api_key');
            window.location.href = '/api/v1/admin/login';
        });
    }

    function removeComposite(compositeId) {
        if (confirm('PERMANENTLY REMOVE this composite from the queue?\\n\\nThis will:\\n- Cancel any active work assignments\\n- Delete all ECM attempts and factors\\n- Remove the composite entirely\\n\\nThis action cannot be undone!')) {
            fetchWithAuth(`/api/v1/admin/composites/${compositeId}`, {method: 'DELETE'})
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'removed') {
                        alert(`Composite ${compositeId} removed successfully.\\nCancelled ${data.cancelled_work_assignments} work assignments.`);
                        refreshPage();  // Use refreshPage() to maintain auth
                    } else {
                        alert('Error removing composite: ' + JSON.stringify(data));
                    }
                })
                .catch(error => {
                    alert('Error removing composite: ' + error);
                });
        }
    }

    function cleanupExpired() {
        if (confirm('Clean up expired work assignments?')) {
            fetchWithAuth('/api/v1/admin/work/cleanup', {method: 'POST'})
                .then(response => response.json())
                .then(data => {
                    alert('Cleaned up ' + data.cleaned_up + ' expired assignments');
                    refreshPage();  // Use refreshPage() to maintain auth
                });
        }
    }

    function cleanupOrphanedResidues() {
        if (confirm('Scan for and cleanup orphaned residues?\n\nThis will find residue records in the database that no longer have corresponding files (typically after deployments) and mark them as expired.\n\nThis is safe and reversible.')) {
            // Show loading indicator (change button text temporarily)
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚è≥ Scanning...';
            btn.disabled = true;

            fetchWithAuth('/api/v1/admin/residues/cleanup-orphaned', {method: 'POST'})
                .then(response => response.json())
                .then(data => {
                    console.log('Cleanup response:', data);
                    if (data.cleaned_up > 0) {
                        const ids = data.orphaned_residues.map(r => r.id).join(', ');
                        alert(`Cleaned up ${data.cleaned_up} orphaned residue(s)\n\nIDs: ${ids}\n\nThese residues had database records but missing files and have been marked as expired.`);
                    } else {
                        // Show debugging info
                        const debugInfo = data.all_residues_checked.map(r =>
                            `ID ${r.id}: ${r.exists ? '‚úì' : '‚úó'} ${r.storage_path}`
                        ).join('\n');
                        alert(`No orphaned residues found.\n\nChecked ${data.total_checked} residue(s).\n\nSee browser console for detailed path information.`);
                        console.log('All residues checked:', data.all_residues_checked);
                    }
                    refreshPage();
                })
                .catch(error => {
                    alert('Error cleaning up orphaned residues: ' + error);
                })
                .finally(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                });
        }
    }

    function calculateTLevels() {
        if (confirm('Calculate t-levels for all composites using 4/13 * digits formula?')) {
            fetchWithAuth('/api/v1/admin/composites/calculate-t-levels', {method: 'POST'})
                .then(response => response.json())
                .then(data => {
                    alert(data.message || 'T-levels calculated successfully');
                    refreshPage();  // Use refreshPage() to maintain auth
                })
                .catch(error => {
                    alert('Error calculating t-levels: ' + error);
                });
        }
    }

    function recalculateAllTLevels() {
        if (confirm('RECALCULATE ALL t-levels? This will run in the background and may take several minutes.\n\nThis will replace current random t-level values with real calculations using the t-level executable.')) {
            fetchWithAuth('/api/v1/admin/composites/recalculate-all-t-levels', {method: 'POST'})
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'started') {
                        alert('T-level recalculation started in background.\n\nThe process will continue even if you navigate away from this page.\n\nCheck the browser console or server logs for progress.');

                        // Poll for status updates
                        const statusInterval = setInterval(() => {
                            fetchWithAuth('/api/v1/admin/composites/recalculate-status')
                                .then(response => response.json())
                                .then(status => {
                                    console.log(`T-level recalculation progress: ${status.progress}/${status.total}`);

                                    if (status.completed) {
                                        clearInterval(statusInterval);
                                        if (status.result && status.result.status === 'completed') {
                                            console.log('T-level recalculation completed!', status.result);
                                            alert(`T-level recalculation completed!\n\n${status.result.message}`);
                                            refreshPage();
                                        } else if (status.result && status.result.status === 'error') {
                                            console.error('T-level recalculation failed:', status.result);
                                            alert(`T-level recalculation failed:\n\n${status.result.message}`);
                                        }
                                    }
                                })
                                .catch(error => {
                                    console.error('Error checking status:', error);
                                    clearInterval(statusInterval);
                                });
                        }, 5000); // Check every 5 seconds
                    } else if (data.status === 'already_running') {
                        alert(`T-level recalculation is already running.\n\nProgress: ${data.progress}/${data.total}`);
                    } else {
                        alert(data.message || 'T-level recalculation response: ' + JSON.stringify(data));
                    }
                })
                .catch(error => {
                    alert('Error starting t-level recalculation: ' + error);
                });
        }
    }

    function refreshPage() {
        // Reload with auth header
        const apiKey = sessionStorage.getItem('admin_api_key');
        if (!apiKey) {
            window.location.href = '/api/v1/admin/login';
            return;
        }

        fetchWithAuth('/api/v1/admin/dashboard')
            .then(response => response.text())
            .then(html => {
                document.open();
                document.write(html);
                document.close();
            })
            .catch(() => {
                window.location.href = '/api/v1/admin/login';
            });
    }

    function deleteCurve(attemptId, compositeId) {
        if (!compositeId) {
            alert('Cannot delete curve: composite ID not found');
            return;
        }

        if (confirm(`Delete this curve (attempt #${attemptId})?\n\nThis will:\n- Remove the ECM attempt from the database\n- Recalculate the t-level for the composite\n\nThis action cannot be undone!`)) {
            fetchWithAuth(`/api/v1/admin/attempts/${attemptId}?composite_id=${compositeId}`, {method: 'DELETE'})
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'deleted') {
                        alert(`Curve deleted successfully.\n\nT-level updated:\n  Before: t${data.old_t_level}\n  After: t${data.new_t_level}`);
                        refreshPage();  // Use refreshPage() to maintain auth
                    } else {
                        alert('Error deleting curve: ' + JSON.stringify(data));
                    }
                })
                .catch(error => {
                    alert('Error deleting curve: ' + error);
                });
        }
    }

    function expireWork(workId) {
        if (confirm(`Expire this work assignment?\n\nWork ID: ${workId}\n\nThis will:\n- Mark the work as "timeout"\n- Make it available for reassignment\n\nAre you sure?`)) {
            // Use the cleanup endpoint which marks work as timeout
            // We'll need to call the cancel endpoint with status 'timeout'
            fetchWithAuth(`/api/v1/admin/work/assignments/${workId}?reason=admin_timeout`, {method: 'DELETE'})
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'cancelled') {
                        alert(`Work assignment expired successfully.\n\nWork ID: ${workId}`);
                        refreshPage();
                    } else {
                        alert('Error expiring work: ' + JSON.stringify(data));
                    }
                })
                .catch(error => {
                    alert('Error expiring work: ' + error);
                });
        }
    }

    function cancelWork(workId) {
        if (confirm(`CANCEL this work assignment?\n\nWork ID: ${workId}\n\nThis will:\n- Mark the work as "failed"\n- Make it available for reassignment\n\nThis action cannot be undone!`)) {
            fetchWithAuth(`/api/v1/admin/work/assignments/${workId}?reason=admin_cancel`, {method: 'DELETE'})
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'cancelled') {
                        alert(`Work assignment cancelled successfully.\n\nWork ID: ${workId}`);
                        refreshPage();
                    } else {
                        alert('Error cancelling work: ' + JSON.stringify(data));
                    }
                })
                .catch(error => {
                    alert('Error cancelling work: ' + error);
                });
        }
    }

    function deleteFactor(factorId, factorValue) {
        if (confirm(`Are you sure you want to delete factor ${factorValue}?\n\nThis action cannot be undone!`)) {
            fetchWithAuth(`/api/v1/admin/factors/${factorId}`, {method: 'DELETE'})
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`Factor ${factorValue} deleted successfully.`);
                        refreshPage();
                    } else {
                        alert('Error deleting factor: ' + JSON.stringify(data));
                    }
                })
                .catch(error => {
                    alert('Error deleting factor: ' + error);
                });
        }
    }
</script>
{% endblock %}
